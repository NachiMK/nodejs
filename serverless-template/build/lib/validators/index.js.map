{"version":3,"sources":["../../../src/lib/validators/index.js"],"names":["validateAjv","getPayload","getJsonSchema","event","ajv","coerceTypes","allErrors","verbose","format","removeAdditional","schema","data","exists","existsSync","JSON","parse","readFileSync","res","json","validate","compile","valid","validationErrors","errors","map","message","item","dataPath","Array","isArray","err","Error","statusCode","validateBody","body","validateQuery","query","validateParams","params","validateQueryAndParams","Object","assign","validateAll"],"mappings":";;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;;;;;AAEO,MAAMA,oCAAcC,cAAcC;AAAA,6CAAiB,WAAOC,KAAP,EAAiB;AACzE,UAAMC,MAAM,kBAAQ;AAClBC,mBAAa,IADK;AAElBC,iBAAW,IAFO;AAGlBC,eAAS,IAHS;AAIlBC,cAAQ,MAJU;AAKlBC,wBAAkB;AALA,KAAR,CAAZ;;AAQA,QAAIC,SAAS,IAAb;AACA,QAAIC,OAAO,IAAX;;AAEA,QAAI,wBAAWT,aAAX,CAAJ,EAA+B;AAC7BQ,eAAS,MAAMR,cAAcC,KAAd,CAAf;AACD,KAFD,MAEO;AACLO,eAASR,aAAT;AACD;;AAED,QAAI,sBAASQ,MAAT,CAAJ,EAAsB;AACpB,YAAME,SAAS,aAAGC,UAAH,CAAcH,MAAd,CAAf;AACA,UAAIE,MAAJ,EAAY;AACVF,iBAASI,KAAKC,KAAL,CAAW,aAAGC,YAAH,CAAgBN,MAAhB,EAAwB,MAAxB,CAAX,CAAT;AACD,OAFD,MAEO;AACL,cAAMO,MAAM,MAAM,yBAAMf,aAAN,CAAlB;AACAQ,iBAAS,MAAMO,IAAIC,IAAJ,EAAf;AACD;AACF;;AAKD,UAAMC,WAAWf,IAAIgB,OAAJ,CAAYV,MAAZ,CAAjB;;AAEA,QAAI,wBAAWT,UAAX,CAAJ,EAA4B;AAC1BU,aAAO,MAAMV,WAAWE,KAAX,CAAb;AACD,KAFD,MAEO;AACLQ,aAAOV,UAAP;AACD;;AAED,UAAMoB,QAAQF,SAASR,IAAT,CAAd;;AAEA,QAAI,CAACU,KAAL,EAAY;AACV,YAAMC,mBAAmBH,SAASI,MAAT,CAAgBC,GAAhB,CAAoB;AAAA,eAAS;AACpDC,mBAAU,GAAEC,KAAKC,QAAS,IAAGD,KAAKD,OAAQ,GAAEG,MAAMC,OAAN,CAAcH,KAAKhB,MAAnB,IAA6BgB,KAAKhB,MAAlC,GAA2C,EAAG;AADtC,SAAT;AAAA,OAApB,CAAzB;AAGA,YAAMoB,MAAM,IAAIC,KAAJ,CAAU,sBAAV,CAAZ;AACAD,UAAIP,MAAJ,GAAaD,gBAAb;AACAQ,UAAIE,UAAJ,GAAiB,GAAjB;AACA,YAAMF,GAAN;AACD;AACF,GAlDwC;;AAAA;AAAA;AAAA;AAAA,IAAlC;;AAoDA,MAAMG,sCAAejC,YAAYG,SAASA,MAAM+B,IAA3B,CAArB;AACA,MAAMC,wCAAgBnC,YAAYG,SAASA,MAAMiC,KAA3B,CAAtB;AACA,MAAMC,0CAAiBrC,YAAYG,SAASA,MAAMmC,MAA3B,CAAvB;AACA,MAAMC,0DAAyBvC,YAAY,CAAC;AACjDoC,UAAQ,EADyC;AAEjDE,WAAS;AAFwC,CAAD,KAG5CE,OAAOC,MAAP,CAAc,EAAd,EAAkBL,KAAlB,EAAyBE,MAAzB,CAHgC,CAA/B;AAIA,MAAMI,oCAAc1C,YAAY,CAAC;AACtCkC,SAAO,EAD+B;AAEtCE,UAAQ,EAF8B;AAGtCE,WAAS;AAH6B,CAAD,KAIjCE,OAAOC,MAAP,CAAc,EAAd,EAAkBP,IAAlB,EAAwBE,KAAxB,EAA+BE,MAA/B,CAJqB,CAApB","file":"index.js","sourcesContent":["import Ajv from 'ajv'\nimport fs from 'fs'\nimport { isFunction, isString } from 'lodash'\nimport fetch from 'node-fetch'\n\nexport const validateAjv = getPayload => getJsonSchema => async (event) => {\n  const ajv = new Ajv({\n    coerceTypes: true,\n    allErrors: true,\n    verbose: true,\n    format: 'full',\n    removeAdditional: true,\n  })\n\n  let schema = null\n  let data = null\n\n  if (isFunction(getJsonSchema)) {\n    schema = await getJsonSchema(event)\n  } else {\n    schema = getJsonSchema\n  }\n\n  if (isString(schema)) {\n    const exists = fs.existsSync(schema)\n    if (exists) {\n      schema = JSON.parse(fs.readFileSync(schema, 'utf8'))\n    } else {\n      const res = await fetch(getJsonSchema)\n      schema = await res.json()\n    }\n  }\n\n  // TODO: Modify schema to allow removing additional (need to do recursively)\n  // schema.additionalProperties = false;\n\n  const validate = ajv.compile(schema)\n\n  if (isFunction(getPayload)) {\n    data = await getPayload(event)\n  } else {\n    data = getPayload\n  }\n\n  const valid = validate(data)\n\n  if (!valid) {\n    const validationErrors = validate.errors.map(item => ({\n      message: `${item.dataPath} ${item.message}${Array.isArray(item.schema) ? item.schema : ''}`,\n    }))\n    const err = new Error('Request is not valid')\n    err.errors = validationErrors\n    err.statusCode = 400\n    throw err\n  }\n}\n\nexport const validateBody = validateAjv(event => event.body)\nexport const validateQuery = validateAjv(event => event.query)\nexport const validateParams = validateAjv(event => event.params)\nexport const validateQueryAndParams = validateAjv(({\n  query = {},\n  params = {},\n}) => Object.assign({}, query, params))\nexport const validateAll = validateAjv(({\n  body = {},\n  query = {},\n  params = {},\n}) => Object.assign({}, body, query, params))\n"]}